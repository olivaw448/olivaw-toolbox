<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Owner Finder IP/domain/string</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background-color: #f5f5f5;
      color: #333;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .layout {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      margin: 2rem;
    }
    .leftPanel {
      width: 400px;
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .rightPanel {
      flex: 1;
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
    }
    label {
      display: inline-block;
      margin-top: 1rem;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    .checkbox-area,
    .button-area {
      margin-top: 1rem;
    }
    button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      background-color: #4CAF50;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    #dropZone {
      margin-top: 1rem;
      padding: 1rem;
      border: 2px dashed #ccc;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
    }
    #dropZone.dragover {
      background-color: #e0ffe0;
      border-color: #4CAF50;
    }
    #output {
      margin-top: 1rem;
      background-color: #fafafa;
      padding: 1rem;
      border-radius: 4px;
      border: 1px solid #ddd;
      min-height: 50px;
    }
  </style>
</head>
<body>
<div class="layout">
  <div class="leftPanel">
    <h2>Excel Owner Finder IP/domain/string</h2>
    <p>Drag & drop an Excel file below or click to select.</p>
    <div id="dropZone">Drop Excel file here or click to select</div>
    <input type="file" id="fileInput" accept=".xls,.xlsx" style="display:none;" />

    <div>
      <label for="sheetNameInput">Sheet name (optional):</label>
      <input type="text" id="sheetNameInput" placeholder="Enter sheet name (optional)" />
    </div>

    <div>
      <label for="teamColumnInput">Owner/Team column number (1-based):</label>
      <input type="number" id="teamColumnInput" value="1" placeholder="e.g., 1" />
    </div>

    <div class="checkbox-area">
      <input type="checkbox" id="rangeCheckbox" />
      <label for="rangeCheckbox">Search only in a specific column range (1-based)</label>
      <div style="margin-left: 20px;">
        <label for="rangeStart">From column:</label>
        <input type="number" id="rangeStart" value="2" min="1" />

        <label for="rangeEnd">To column:</label>
        <input type="number" id="rangeEnd" value="5" min="1" />
      </div>
    </div>

    <div class="checkbox-area">
      <input type="checkbox" id="removePortCheckbox" checked />
      <label for="removePortCheckbox">Ignore port (remove ":port")</label>
    </div>

    <div>
      <label for="separatorInput">Item separator:</label>
      <input type="text" id="separatorInput" value="," placeholder="Enter a separator character" />
    </div>

    <div>
      <label for="ipList">List of IPs/domains/words:</label>
      <textarea id="ipList" rows="6" placeholder="e.g.\n192.168.0.1:8080, test.com:123\nmyword..."></textarea>
    </div>

    <div class="checkbox-area">
      <input type="checkbox" id="searchInsideCheckbox" />
      <label for="searchInsideCheckbox">Substring search</label>
    </div>

    <div class="button-area">
      <button onclick="processExcel()">Process</button>
    </div>
  </div>

  <div class="rightPanel">
    <h2>Results</h2>
    <div id="output"></div>
  </div>
</div>

<script>
  let droppedFile = null;

  // Utility: escape special regex characters
  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Utility: strip ":port"
  function stripPort(value) {
    const colonIndex = value.indexOf(":");
    return (colonIndex !== -1) ? value.substring(0, colonIndex) : value;
  }

  // Drag & Drop logic
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('click', () => {
    fileInput.click();
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      droppedFile = e.dataTransfer.files[0];
      dropZone.textContent = `File selected: ${droppedFile.name}`;
    }
  });

  // Also handle changes via file input
  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      droppedFile = fileInput.files[0];
      dropZone.textContent = `File selected: ${droppedFile.name}`;
    }
  });

  function processExcel() {
    const sheetNameInput = document.getElementById('sheetNameInput').value.trim();
    const teamColumnInput = parseInt(document.getElementById('teamColumnInput').value, 10);
    const rangeCheckbox = document.getElementById('rangeCheckbox').checked;
    const rangeStart = parseInt(document.getElementById('rangeStart').value, 10);
    const rangeEnd = parseInt(document.getElementById('rangeEnd').value, 10);
    const removePortCheckbox = document.getElementById('removePortCheckbox').checked;
    const separatorInput = document.getElementById('separatorInput').value;
    const ipListRaw = document.getElementById('ipList').value;
    const searchInsideCheckbox = document.getElementById('searchInsideCheckbox').checked;
    const output = document.getElementById('output');
    output.innerHTML = "";

    if (!droppedFile) {
      alert("Please select an Excel file.");
      return;
    }

    if (isNaN(teamColumnInput) || teamColumnInput < 1) {
      alert("Invalid Owner/Team column number.");
      return;
    }

    // For range
    let rs = rangeStart;
    let re = rangeEnd;
    if (!rangeCheckbox) {
      // If the checkbox isn't checked, we won't limit columns, so set them to some large range:
      rs = 1;
      re = 1000; // Arbitrary big number
    }
    if (rs > re) {
      // swap if user typed 5..2
      [rs, re] = [re, rs];
    }

    // Prepare user item list
    const escapedSep = escapeRegex(separatorInput);
    const userSplitRegex = new RegExp(`[;\\n,${escapedSep}]+`, 'g');
    let userItems = ipListRaw.split(userSplitRegex).map(s => s.trim()).filter(Boolean);
    if (removePortCheckbox) {
      userItems = userItems.map(stripPort);
    }
    userItems = userItems.map(u => u.toLowerCase());

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // pick a sheet
        let targetSheetName = sheetNameInput || workbook.SheetNames[0];
        if (!workbook.SheetNames.includes(targetSheetName)) {
          alert(`Sheet "${targetSheetName}" not found in the file.`);
          return;
        }

        const sheet = workbook.Sheets[targetSheetName];

        // decode range to find how many rows are in the sheet
        const range = XLSX.utils.decode_range(sheet["!ref"]);
        const maxRow = range.e.r + 1; // last row index is e.r, but 1-based is row count
        // we won't limit columns by the actual used range if user specified them

        // Regex for splitting cell contents
        const cellSplitRegex = new RegExp(`[;\\n,${escapedSep}]+`, 'g');

        // Where we store found matches
        const itemToTeams = new Map();
        let currentTeam = "";

        // We'll loop through all rows from 1..maxRow
        for (let row = 1; row <= maxRow; row++) {
          // 1) Read the team cell if it exists
          const teamColLetter = XLSX.utils.encode_col(teamColumnInput - 1); // e.g. 1 => A, 2 => B...
          const teamCellRef = teamColLetter + row; // e.g. A1, B2, ...
          const teamCellObj = sheet[teamCellRef];
          let teamVal = teamCellObj ? teamCellObj.v : "";
          if (teamVal && teamVal.toString().trim() !== "") {
            currentTeam = teamVal.toString().trim();
          }

          // 2) For each column in [rs..re], skip if it's the team column
          for (let colNum = rs; colNum <= re; colNum++) {
            if (colNum === teamColumnInput) {
              // skip the team column
              continue;
            }
            const colLetter = XLSX.utils.encode_col(colNum - 1);
            const cellRef = colLetter + row;
            const cellObj = sheet[cellRef];
            if (!cellObj) continue;
            const rawVal = cellObj.v;
            if (!rawVal || rawVal.toString().trim() === "") continue;

            // parse
            let cellStr = rawVal.toString().replace(/[\r\u2028\u2029]+/g, "\n");
            let cellItems = cellStr.split(cellSplitRegex).map(x => x.trim()).filter(Boolean);

            if (removePortCheckbox) {
              cellItems = cellItems.map(stripPort);
            }

            for (const cItemRaw of cellItems) {
              const cItem = cItemRaw.toLowerCase();

              for (const userVal of userItems) {
                let isMatch = false;
                if (searchInsideCheckbox) {
                  if (cItem.includes(userVal)) {
                    isMatch = true;
                  }
                } else {
                  if (cItem === userVal) {
                    isMatch = true;
                  }
                }

                if (isMatch) {
                  if (!itemToTeams.has(cItem)) {
                    itemToTeams.set(cItem, new Set());
                  }
                  itemToTeams.get(cItem).add(currentTeam);
                  break; // next item in the cell
                }
              }
            }
          }
        }

        // build final output
        const labelToItems = new Map();
        for (const [item, teamsSet] of itemToTeams.entries()) {
          if (teamsSet.size === 0) continue;
          if (teamsSet.size === 1) {
            const [onlyTeam] = teamsSet;
            const label = `Team: ${onlyTeam}`;
            if (!labelToItems.has(label)) {
              labelToItems.set(label, new Set());
            }
            labelToItems.get(label).add(item);
          } else {
            const teamArr = [...teamsSet].sort();
            const label = `In multiple teams: ${teamArr.join(" & ")}`;
            if (!labelToItems.has(label)) {
              labelToItems.set(label, new Set());
            }
            labelToItems.get(label).add(item);
          }
        }

        if (labelToItems.size === 0) {
          output.innerHTML = "<p>No matches found.</p>";
          return;
        }

        let html = "";
        for (const [label, itemsSet] of labelToItems.entries()) {
          const itemsArr = [...itemsSet];
          if (!label || itemsArr.length === 0) continue;

          html += `<h4>${label}</h4>`;
          html += "<ul>";
          for (const i of itemsArr) {
            html += `<li>${i}</li>`;
          }
          html += "</ul>";
        }

        output.innerHTML = html;
      } catch (err) {
        console.error(err);
        output.innerHTML = `<p>Error reading file: ${err.message}</p>`;
      }
    };

    reader.readAsArrayBuffer(droppedFile);
  }
</script>
</body>
</html>